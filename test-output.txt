
> njdsc-school-compliance-portal@1.0.0 test
> jest tests/unit/services/localJsonService.test.js

  console.log
    [dotenv@17.2.3] injecting env (15) from .env.development -- tip: 📡 add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.267Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.273Z' }

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.286Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.286Z' }

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory does not exist, creating: ./data

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:38:13)

  console.log
    [LOCAL JSON SERVICE] Data directory created successfully: ./data

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:41:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.288Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.289Z' }

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory does not exist, creating: ./data

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:38:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.302Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.303Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.304Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.306Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.306Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.307Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.309Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.309Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.310Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.311Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.312Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.313Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.314Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.315Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.316Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    JSON parse error in corrupted, returning empty array: Unexpected token 'i', "invalid json {" is not valid JSON

    [0m [90m 93 |[39m       [90m// Handle JSON parse errors (corrupted or empty files)[39m
     [90m 94 |[39m       [36mif[39m (error [36minstanceof[39m [33mSyntaxError[39m) {
    [31m[1m>[22m[39m[90m 95 |[39m         console[33m.[39mwarn([32m`JSON parse error in ${filename}, returning empty array:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 96 |[39m         [36mreturn[39m [][33m;[39m
     [90m 97 |[39m       }
     [90m 98 |[39m[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:95:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:111:22)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.328Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.329Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.329Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    File read attempt 1 failed for retry, retrying in 100ms: Temporary error

    [0m [90m 104 |[39m       [90m// Wait before retrying[39m
     [90m 105 |[39m       [36mconst[39m delay [33m=[39m baseDelay [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m attempt)[33m;[39m
    [31m[1m>[22m[39m[90m 106 |[39m       console[33m.[39mwarn([32m`File read attempt ${attempt + 1} failed for ${filename}, retrying in ${delay}ms:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 107 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m delay))[33m;[39m
     [90m 108 |[39m     }
     [90m 109 |[39m   }[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:106:15)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:121:22)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.442Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.444Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.448Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.449Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.449Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    File read attempt 1 failed for failing, retrying in 100ms: Persistent error

    [0m [90m 104 |[39m       [90m// Wait before retrying[39m
     [90m 105 |[39m       [36mconst[39m delay [33m=[39m baseDelay [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m attempt)[33m;[39m
    [31m[1m>[22m[39m[90m 106 |[39m       console[33m.[39mwarn([32m`File read attempt ${attempt + 1} failed for ${filename}, retrying in ${delay}ms:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 107 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m delay))[33m;[39m
     [90m 108 |[39m     }
     [90m 109 |[39m   }[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:106:15)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:130:7)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.566Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.567Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    File read attempt 2 failed for failing, retrying in 200ms: Persistent error

    [0m [90m 104 |[39m       [90m// Wait before retrying[39m
     [90m 105 |[39m       [36mconst[39m delay [33m=[39m baseDelay [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m attempt)[33m;[39m
    [31m[1m>[22m[39m[90m 106 |[39m       console[33m.[39mwarn([32m`File read attempt ${attempt + 1} failed for ${filename}, retrying in ${delay}ms:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 107 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m delay))[33m;[39m
     [90m 108 |[39m     }
     [90m 109 |[39m   }[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:106:15)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:130:7)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.786Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.787Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.796Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.797Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:40.798Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    File undefined returned undefined or null data

    [0m [90m 73 |[39m       [90m// Ensure data is a valid string[39m
     [90m 74 |[39m       [36mif[39m (data [33m===[39m undefined [33m||[39m data [33m===[39m [36mnull[39m) {
    [31m[1m>[22m[39m[90m 75 |[39m         console[33m.[39mwarn([32m`File ${filename} returned undefined or null data`[39m)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 76 |[39m         [36mreturn[39m [][33m;[39m
     [90m 77 |[39m       }
     [90m 78 |[39m[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:75:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:138:22)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:40.802Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'test',
      dataDir: './data',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      dataLength: 1,
      timestamp: '2025-10-22T15:43:40.803Z'
    }

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:155:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:155:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:155:7)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'test',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at Object.writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:155:7)'
      },
      timestamp: '2025-10-22T15:43:41.025Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:385:13)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:155:7)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.029Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'test',
      dataDir: './data',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      dataLength: 1,
      timestamp: '2025-10-22T15:43:41.030Z'
    }

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:175:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:175:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:175:7)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'test',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at Object.writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:175:7)'
      },
      timestamp: '2025-10-22T15:43:41.255Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:385:13)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:175:7)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.258Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'test',
      dataDir: './data',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      dataLength: 1,
      timestamp: '2025-10-22T15:43:41.259Z'
    }

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): Write failed

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:185:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): Write failed

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:185:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): Write failed

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:185:7)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'test',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: Write failed',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: Write failed\n' +
          '    at Object.writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:185:7)'
      },
      timestamp: '2025-10-22T15:43:41.488Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:385:13)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:185:7)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.491Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'test',
      dataDir: './data',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      dataLength: 1,
      timestamp: '2025-10-22T15:43:41.491Z'
    }

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:195:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:195:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/test.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:195:7)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'test',
      filePath: './data/test.json',
      tempFilePath: './data/test.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at Object.writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:195:7)'
      },
      timestamp: '2025-10-22T15:43:41.724Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:385:13)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:195:7)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.727Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.728Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:41.728Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.729Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.730Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:41.730Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.732Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.732Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:41.733Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.733Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'sheet1',
      dataDir: './data',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      dataLength: 2,
      timestamp: '2025-10-22T15:43:41.734Z'
    }

      at log (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:236:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:236:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:236:24)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'sheet1',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.appendRow (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:431:3)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:236:24)'
      },
      timestamp: '2025-10-22T15:43:41.957Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at error (server/services/localJsonService.js:385:13)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:236:24)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at log (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.959Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.960Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:41.960Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:41.961Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'sheet1',
      dataDir: './data',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      dataLength: 1,
      timestamp: '2025-10-22T15:43:41.961Z'
    }

      at log (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:250:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:250:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:250:24)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'sheet1',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.appendRow (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:431:3)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:250:24)'
      },
      timestamp: '2025-10-22T15:43:42.177Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at error (server/services/localJsonService.js:385:13)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:250:24)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at log (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.179Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.180Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.180Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.182Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'sheet1',
      dataDir: './data',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      dataLength: 2,
      timestamp: '2025-10-22T15:43:42.182Z'
    }

      at log (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.updateRow (server/services/localJsonService.js:453:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:271:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.updateRow (server/services/localJsonService.js:453:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:271:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.updateRow (server/services/localJsonService.js:453:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:271:24)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'sheet1',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.updateRow (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:453:3)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:271:24)'
      },
      timestamp: '2025-10-22T15:43:42.413Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at error (server/services/localJsonService.js:385:13)
      at Object.updateRow (server/services/localJsonService.js:453:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:271:24)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at log (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.418Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.419Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.421Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.423Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.424Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.424Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.425Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'sheet1',
      dataDir: './data',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      dataLength: 2,
      timestamp: '2025-10-22T15:43:42.425Z'
    }

      at log (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.deleteRow (server/services/localJsonService.js:473:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:298:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.deleteRow (server/services/localJsonService.js:473:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:298:24)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/sheet1.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.deleteRow (server/services/localJsonService.js:473:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:298:24)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'sheet1',
      filePath: './data/sheet1.json',
      tempFilePath: './data/sheet1.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.deleteRow (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:473:3)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:298:24)'
      },
      timestamp: '2025-10-22T15:43:42.647Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at error (server/services/localJsonService.js:385:13)
      at Object.deleteRow (server/services/localJsonService.js:473:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:298:24)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at log (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.652Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.653Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.654Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.655Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.656Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.656Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.658Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.658Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.659Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.660Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.661Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.662Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.664Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.665Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.666Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.667Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.669Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.669Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'newSheet',
      dataDir: './data',
      filePath: './data/newSheet.json',
      tempFilePath: './data/newSheet.json.tmp',
      dataLength: 0,
      timestamp: '2025-10-22T15:43:42.670Z'
    }

      at log (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/newSheet.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.ensureSheetExists (server/services/localJsonService.js:514:5)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:394:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/newSheet.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.ensureSheetExists (server/services/localJsonService.js:514:5)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:394:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/newSheet.json.tmp

      at log (server/services/localJsonService.js:152:17)

  console.log
    [LOCAL JSON SERVICE] Temp file written successfully

      at log (server/services/localJsonService.js:154:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): fs.stat is not a function

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at error (server/services/localJsonService.js:166:17)
      at Object.ensureSheetExists (server/services/localJsonService.js:514:5)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:394:7)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'newSheet',
      filePath: './data/newSheet.json',
      tempFilePath: './data/newSheet.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: fs.stat is not a function',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: fs.stat is not a function\n' +
          '    at writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.ensureSheetExists (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:514:5)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:394:7)'
      },
      timestamp: '2025-10-22T15:43:42.900Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at error (server/services/localJsonService.js:385:13)
      at Object.ensureSheetExists (server/services/localJsonService.js:514:5)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:394:7)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at log (server/services/localJsonService.js:403:15)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: '/custom/data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './/custom/data',
      timestamp: '2025-10-22T15:43:42.905Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './/custom/data', timestamp: '2025-10-22T15:43:42.905Z' }

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: .//custom/data

      at Object.log [as ensureDataDirectory] (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.910Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:42.912Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:42.913Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    File read attempt 1 failed for error, retrying in 100ms: Read error

    [0m [90m 104 |[39m       [90m// Wait before retrying[39m
     [90m 105 |[39m       [36mconst[39m delay [33m=[39m baseDelay [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m attempt)[33m;[39m
    [31m[1m>[22m[39m[90m 106 |[39m       console[33m.[39mwarn([32m`File read attempt ${attempt + 1} failed for ${filename}, retrying in ${delay}ms:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 107 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m delay))[33m;[39m
     [90m 108 |[39m     }
     [90m 109 |[39m   }[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:106:15)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:421:7)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:43.035Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:43.036Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.warn
    File read attempt 2 failed for error, retrying in 200ms: Read error

    [0m [90m 104 |[39m       [90m// Wait before retrying[39m
     [90m 105 |[39m       [36mconst[39m delay [33m=[39m baseDelay [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m attempt)[33m;[39m
    [31m[1m>[22m[39m[90m 106 |[39m       console[33m.[39mwarn([32m`File read attempt ${attempt + 1} failed for ${filename}, retrying in ${delay}ms:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 107 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m delay))[33m;[39m
     [90m 108 |[39m     }
     [90m 109 |[39m   }[0m

      at Object.warn [as readJsonFile] (server/services/localJsonService.js:106:15)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:421:7)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:43.251Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] ensureDataDirectory called: { dataDir: './data', timestamp: '2025-10-22T15:43:43.252Z' }

      at log (server/services/localJsonService.js:29:11)

  console.log
    [LOCAL JSON SERVICE] Data directory already exists: ./data

      at log (server/services/localJsonService.js:36:13)

  console.log
    [LOCAL JSON SERVICE] getDataDir called: {
      DATA_DIR: './data',
      cwd: 'c:\\Repos\\UnlicesnsedDrivingSchool',
      resolvedDataDir: './data',
      timestamp: '2025-10-22T15:43:43.253Z'
    }

      at log (server/services/localJsonService.js:14:11)

  console.log
    [LOCAL JSON SERVICE] writeJsonFile called: {
      filename: 'error',
      dataDir: './data',
      filePath: './data/error.json',
      tempFilePath: './data/error.json.tmp',
      dataLength: 0,
      timestamp: '2025-10-22T15:43:43.253Z'
    }

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:124:11)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 1): ./data/error.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 1): Write error

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:429:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 2): ./data/error.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 2): Write error

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:429:7)

  console.log
    [LOCAL JSON SERVICE] Writing temp file (attempt 3): ./data/error.json.tmp

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:152:17)

  console.error
    [LOCAL JSON SERVICE] Temp file write failed (attempt 3): Write error

    [0m [90m 164 |[39m       } [36mcatch[39m (writeError) {
     [90m 165 |[39m         writeAttempts[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 166 |[39m         console[33m.[39merror([32m'[LOCAL JSON SERVICE] Temp file write failed (attempt %d):'[39m[33m,[39m writeAttempts[33m,[39m writeError[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 167 |[39m
     [90m 168 |[39m         [36mif[39m (writeAttempts [33m>=[39m maxWriteAttempts) {
     [90m 169 |[39m           [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write temp file after ${maxWriteAttempts} attempts: ${writeError.message}`[39m)[33m;[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:166:17)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:429:7)

  console.error
    [LOCAL JSON SERVICE] writeJsonFile failed completely: {
      filename: 'error',
      filePath: './data/error.json',
      tempFilePath: './data/error.json.tmp',
      error: {
        message: 'Failed to write temp file after 3 attempts: Write error',
        code: undefined,
        errno: undefined,
        syscall: undefined,
        path: undefined,
        stack: 'Error: Failed to write temp file after 3 attempts: Write error\n' +
          '    at Object.writeJsonFile (C:\\Repos\\UnlicesnsedDrivingSchool\\server\\services\\localJsonService.js:169:17)\n' +
          '    at Object.<anonymous> (C:\\Repos\\UnlicesnsedDrivingSchool\\tests\\unit\\services\\localJsonService.test.js:429:7)'
      },
      timestamp: '2025-10-22T15:43:43.472Z'
    }

    [0m [90m 383 |[39m     [36mthrow[39m lastError[33m;[39m
     [90m 384 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 385 |[39m     console[33m.[39merror([32m'[LOCAL JSON SERVICE] writeJsonFile failed completely:'[39m[33m,[39m {
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 386 |[39m       filename[33m,[39m
     [90m 387 |[39m       filePath[33m,[39m
     [90m 388 |[39m       tempFilePath[33m,[39m[0m

      at Object.error [as writeJsonFile] (server/services/localJsonService.js:385:13)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:429:7)

  console.log
    [LOCAL JSON SERVICE] Temp file cleaned up after error

      at Object.log [as writeJsonFile] (server/services/localJsonService.js:403:15)

FAIL backend tests/unit/services/localJsonService.test.js
  Local JSON Service
    ensureDataDirectory
      √ should not create directory if it already exists (20 ms)
      √ should create directory if it does not exist (3 ms)
      √ should throw error if mkdir fails (14 ms)
    readJsonFile
      √ should read and parse valid JSON file (3 ms)
      √ should return empty array for non-existent file (3 ms)
      √ should return empty array for empty file (3 ms)
      √ should return empty array for whitespace-only file (3 ms)
      √ should handle JSON parse errors gracefully (13 ms)
      √ should retry on read errors and eventually succeed (120 ms)
      √ should throw error after max retries (348 ms)
      √ should handle undefined or null data (6 ms)
    writeJsonFile
      × should write data to JSON file atomically (226 ms)
      × should handle Windows file locking with retries (230 ms)
      √ should clean up temp file on error (232 ms)
      √ should throw error after max retries on Windows (236 ms)
    CRUD Operations
      getAllRows
        √ should get all rows from JSON file (2 ms)
        √ should ignore spreadsheetId parameter (2 ms)
      appendRow
        × should append row to existing data (228 ms)
        × should append to empty file (220 ms)
      updateRow
        × should update existing row (238 ms)
        √ should throw error for non-existent row (4 ms)
      deleteRow
        × should delete existing row and return true (228 ms)
        √ should return false for non-existent row (4 ms)
      findRowById
        √ should find row by ID (2 ms)
        √ should return null for non-existent row (2 ms)
      getRowsByFilter
        √ should filter rows using provided function (4 ms)
        √ should return empty array when no rows match filter (3 ms)
    ensureSheetExists
      √ should not create file if it already exists (1 ms)
      × should create empty JSON file if it does not exist (236 ms)
    Environment configuration
      × should use custom DATA_DIR from environment (5 ms)
    Error handling
      √ should handle read errors gracefully (342 ms)
      √ should handle write errors (222 ms)

  ● Local JSON Service › writeJsonFile › should write data to JSON file atomically

    Failed to write JSON file test: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at Object.writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:155:7)

  ● Local JSON Service › writeJsonFile › should handle Windows file locking with retries

    Failed to write JSON file test: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at Object.writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:175:7)

  ● Local JSON Service › CRUD Operations › appendRow › should append row to existing data

    Failed to write JSON file sheet1: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:236:24)

  ● Local JSON Service › CRUD Operations › appendRow › should append to empty file

    Failed to write JSON file sheet1: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.appendRow (server/services/localJsonService.js:431:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:250:24)

  ● Local JSON Service › CRUD Operations › updateRow › should update existing row

    Failed to write JSON file sheet1: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.updateRow (server/services/localJsonService.js:453:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:271:24)

  ● Local JSON Service › CRUD Operations › deleteRow › should delete existing row and return true

    Failed to write JSON file sheet1: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.deleteRow (server/services/localJsonService.js:473:3)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:298:24)

  ● Local JSON Service › ensureSheetExists › should create empty JSON file if it does not exist

    Failed to write JSON file newSheet: Failed to write temp file after 3 attempts: fs.stat is not a function

    [0m [90m 405 |[39m       console[33m.[39mlog([32m'[LOCAL JSON SERVICE] Temp file cleanup failed (may not exist):'[39m[33m,[39m cleanupError[33m.[39mmessage)[33m;[39m
     [90m 406 |[39m     }
    [31m[1m>[22m[39m[90m 407 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to write JSON file ${filename}: ${error.message}`[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 408 |[39m   }
     [90m 409 |[39m }
     [90m 410 |[39m[0m

      at writeJsonFile (server/services/localJsonService.js:407:11)
      at Object.ensureSheetExists (server/services/localJsonService.js:514:5)
      at Object.<anonymous> (tests/unit/services/localJsonService.test.js:394:7)

  ● Local JSON Service › Environment configuration › should use custom DATA_DIR from environment

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/custom/data"
    Received: ".//custom/data"

    Number of calls: 1

    [0m [90m 411 |[39m       [36mawait[39m localJsonService[33m.[39mensureDataDirectory()[33m;[39m
     [90m 412 |[39m
    [31m[1m>[22m[39m[90m 413 |[39m       expect(fs[33m.[39mpromises[33m.[39maccess)[33m.[39mtoHaveBeenCalledWith([32m'/custom/data'[39m)[33m;[39m
     [90m     |[39m                                  [31m[1m^[22m[39m
     [90m 414 |[39m     })[33m;[39m
     [90m 415 |[39m   })[33m;[39m
     [90m 416 |[39m[0m

      at Object.toHaveBeenCalledWith (tests/unit/services/localJsonService.test.js:413:34)

Test Suites: 1 failed, 1 total
Tests:       8 failed, 24 passed, 32 total
Snapshots:   0 total
Time:        4.481 s, estimated 5 s
Ran all test suites matching tests/unit/services/localJsonService.test.js.
