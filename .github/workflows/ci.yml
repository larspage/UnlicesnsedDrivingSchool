name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test -- --coverage --watchAll=false

    - name: Build application
      run: npm run build

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info

  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Run dependency check
      run: npx npm-check-updates --errorLevel 2

  build:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r dist deploy/
        cp -r server deploy/
        cp package.json deploy/
        cp package-lock.json deploy/
        tar -czf deploy.tar.gz -C deploy .

    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: build-files
        path: deploy.tar.gz
        retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Download build artifact
      uses: actions/download-artifact@v3
      with:
        name: build-files

    - name: Deploy to DigitalOcean Droplet
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.UNLICENSEDDRIVINGSCHOOLIP }}
        username: root
        key: ${{ secrets.UNLICENSEDDRIVERSSH }}
        source: "deploy.tar.gz"
        target: "/tmp"

    - name: Extract and restart application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.UNLICENSEDDRIVINGSCHOOLIP }}
        username: root
        key: ${{ secrets.UNLICENSEDDRIVERSSH }}
        script: |
          # Set deployment directory
          APP_DIR="/var/www/compliance-portal"
          BACKUP_DIR="/var/www/backups"

          echo "🚀 Starting deployment to $APP_DIR"

          # Create backup of current deployment
          if [ -d "$APP_DIR" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            echo "📦 Creating backup: compliance-portal_$TIMESTAMP"
            mkdir -p "$BACKUP_DIR"
            tar -czf "$BACKUP_DIR/compliance-portal_$TIMESTAMP.tar.gz" -C /var/www compliance-portal 2>/dev/null || true
            # Keep only last 5 backups
            cd "$BACKUP_DIR" && ls -t compliance-portal_*.tar.gz | tail -n +6 | xargs -r rm
          fi

          # Create app directory if it doesn't exist
          mkdir -p "$APP_DIR"
          
          # Extract new build
          echo "📦 Extracting new build"
          cd "$APP_DIR"
          tar -xzf /tmp/deploy.tar.gz
          rm /tmp/deploy.tar.gz

          # Install only production dependencies (no build tools needed!)
          echo "📦 Installing production dependencies"
          npm ci --production

          # Copy production environment file if it exists
          if [ -f ".env.production" ]; then
            cp .env.production .env
            echo "✅ Environment configured"
          fi

          # Ensure data directories exist
          mkdir -p /var/www/data /var/www/uploads /var/www/backups
          
          # Initialize data files if they don't exist
          if [ ! -f "/var/www/data/reports.json" ]; then
            echo "[]" > /var/www/data/reports.json
          fi
          if [ ! -f "/var/www/data/config.json" ]; then
            echo "{}" > /var/www/data/config.json
          fi

          # Restart application with PM2
          echo "🔄 Restarting application"
          pm2 stop njdsc-compliance-portal 2>/dev/null || true
          pm2 delete njdsc-compliance-portal 2>/dev/null || true
          pm2 start dist/server/app.js --name "njdsc-compliance-portal"
          pm2 save

          # Reload Nginx if installed
          if command -v nginx &> /dev/null; then
            echo "🔄 Reloading Nginx"
            nginx -t && systemctl reload nginx
          fi

          echo "✅ Deployment completed successfully at $(date)"
          echo "🌐 Application available at: http://167.172.224.98"