name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:        # ✅ Already defined
  security:    # ✅ Already defined
  build:       # ✅ Already defined

  deploy:      # ✅ This is the section we're finalizing
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-files

      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.UNLICENSEDDRIVINGSCHOOLIP }}
          username: root
          key: ${{ secrets.UNLICENSEDDRIVERSSH }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: Extract and restart application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.UNLICENSEDDRIVINGSCHOOLIP }}
          username: root
          key: ${{ secrets.UNLICENSEDDRIVERSSH }}
          script: |
            mkdir -p ~/var/www/unlicenseddrivingschools
            tar -xzf /tmp/deploy.tar.gz -C ~/var/www/unlicenseddrivingschools --strip-components=1
            rm /tmp/deploy.tar.gz
            sudo systemctl restart nginx
